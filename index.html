<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arcane Memory</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
  <style>
    :root {
      --gold: #c9a227;
      --gold-light: #f0d060;
      --arcane: #8b3dbd;
      --arcane-light: #c084fc;
      --forest: #1a5c2e;
      --ember: #b45309;
      --parchment: #f5e6c8;
      --dark-bg: #04080a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'IM Fell English', 'Georgia', serif;
      background: radial-gradient(ellipse at 30% 20%, #0e1a0a 0%, #04080a 40%, #0a0414 70%, #04080a 100%);
      min-height: 100vh;
      overflow: hidden;
      color: var(--parchment);
      cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ctext y='18' font-size='18'%3E‚ú¶%3C/text%3E%3C/svg%3E") 12 12, crosshair;
    }

    /* ---- Mist / Atmosphere ---- */
    #atmosphere {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .mist-layer {
      position: absolute;
      width: 300%;
      height: 100%;
      opacity: 0.06;
      background: radial-gradient(ellipse 40% 60% at 50% 80%, #2a6b3c 0%, transparent 70%);
    }
    .mist-1 { animation: drift 30s ease-in-out infinite alternate; }
    .mist-2 { animation: drift 45s ease-in-out infinite alternate-reverse; opacity: 0.04; top: -20%; }
    .mist-3 {
      background: radial-gradient(ellipse 60% 40% at 50% 100%, #3b1c5a 0%, transparent 70%);
      animation: drift 38s ease-in-out infinite alternate;
      opacity: 0.08;
    }

    @keyframes drift {
      from { transform: translateX(-33%); }
      to   { transform: translateX(0%); }
    }

    /* ---- Floating Particles (fireflies/motes) ---- */
    #particles-canvas {
      position: fixed;
      inset: 0;
      z-index: 1;
      pointer-events: none;
    }

    /* ---- Game Layout ---- */
    #game-container {
      position: relative;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    #game-content {
      max-width: 600px;
      width: 100%;
      text-align: center;
    }

    /* ---- Title ---- */
    .title-wrapper {
      position: relative;
      margin-bottom: 16px;
      animation: float 4s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50%       { transform: translateY(-14px); }
    }

    /* Arcane rings around title orb */
    .rune-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      border-radius: 50%;
      border-style: solid;
      border-color: transparent;
    }

    .ring-1 {
      width: 200%;
      height: 50px;
      border-width: 2px;
      border-top-color: rgba(201, 162, 39, 0.7);
      border-bottom-color: rgba(201, 162, 39, 0.3);
      box-shadow: 0 0 18px rgba(201, 162, 39, 0.4);
      animation: spin-ring 10s linear infinite;
    }

    .ring-2 {
      width: 172%;
      height: 44px;
      border-width: 2px;
      border-top-color: rgba(139, 61, 189, 0.7);
      border-bottom-color: rgba(139, 61, 189, 0.3);
      box-shadow: 0 0 14px rgba(139, 61, 189, 0.5);
      animation: spin-ring 7s linear infinite reverse;
    }

    .ring-3 {
      width: 148%;
      height: 38px;
      border-width: 1.5px;
      border-top-color: rgba(26, 92, 46, 0.8);
      border-bottom-color: rgba(26, 92, 46, 0.4);
      box-shadow: 0 0 12px rgba(26, 92, 46, 0.5);
      animation: spin-ring 14s linear infinite;
    }

    .ring-4 {
      width: 128%;
      height: 32px;
      border-width: 1px;
      border-top-color: rgba(192, 132, 252, 0.5);
      border-bottom-color: rgba(192, 132, 252, 0.2);
      animation: spin-ring 5s linear infinite reverse;
    }

    @keyframes spin-ring {
      from { transform: translate(-50%, -50%) rotateX(70deg) rotateZ(0deg); }
      to   { transform: translate(-50%, -50%) rotateX(70deg) rotateZ(360deg); }
    }

    h1 {
      font-family: 'Cinzel Decorative', 'Georgia', serif;
      font-size: 3.2rem;
      font-weight: 900;
      background: linear-gradient(135deg, #c9a227 0%, #f0d060 30%, #c9a227 50%, #8b3dbd 70%, #c9a227 100%);
      background-size: 300% auto;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer-gold 4s linear infinite;
      filter: drop-shadow(0 0 24px rgba(201, 162, 39, 0.6));
      position: relative;
      z-index: 3;
      letter-spacing: 0.05em;
    }

    @keyframes shimmer-gold {
      0%   { background-position: 0% center; }
      100% { background-position: 300% center; }
    }

    .tagline {
      font-family: 'IM Fell English', 'Georgia', serif;
      font-style: italic;
      font-size: 1.1rem;
      color: #a89060;
      margin-bottom: 36px;
      letter-spacing: 0.08em;
      position: relative;
      z-index: 2;
    }

    /* ---- Buttons ---- */
    .button {
      font-family: 'Cinzel', 'Georgia', serif;
      background: linear-gradient(135deg, #1a1008, #2a1a05);
      color: var(--gold);
      font-size: 1.1rem;
      font-weight: 600;
      padding: 14px 32px;
      border: 1px solid rgba(201, 162, 39, 0.6);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 0 20px rgba(201, 162, 39, 0.2), inset 0 0 12px rgba(201, 162, 39, 0.05);
      margin: 10px;
      position: relative;
      z-index: 2;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .button:hover {
      background: linear-gradient(135deg, #2a1a05, #3d2708);
      box-shadow: 0 0 35px rgba(201, 162, 39, 0.5), inset 0 0 20px rgba(201, 162, 39, 0.1);
      border-color: var(--gold);
      transform: translateY(-2px);
    }

    .button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    /* ---- Spell Rune Buttons (game grid) ---- */
    .game-buttons-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      max-width: 380px;
      margin: 36px auto;
      position: relative;
      z-index: 2;
    }

    .game-button {
      aspect-ratio: 1;
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.15s;
      filter: brightness(0.65) saturate(0.8);
      position: relative;
      z-index: 3;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
    }

    /* Rune glyph labels */
    .game-button::before {
      font-size: 3.5rem;
      position: relative;
      z-index: 2;
      text-shadow: none;
      filter: drop-shadow(0 0 12px currentColor);
      transition: all 0.15s;
      pointer-events: none;
    }

    .game-button::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 14px;
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,0.25), transparent 70%);
      pointer-events: none;
    }

    /* Fire */
    .game-button-0 {
      background: linear-gradient(135deg, #7c1d06, #c2410c, #7c1d06);
      box-shadow: 0 4px 24px rgba(194, 65, 12, 0.4);
      border-color: rgba(251, 146, 60, 0.35);
    }
    .game-button-0::before { content: 'üî•'; }
    .game-button-0.active  { box-shadow: 0 0 55px #fb923c, 0 0 20px #fb923c; border-color: #fb923c; }

    /* Frost */
    .game-button-1 {
      background: linear-gradient(135deg, #0c2d4a, #0e6fb5, #0c2d4a);
      box-shadow: 0 4px 24px rgba(14, 111, 181, 0.4);
      border-color: rgba(125, 211, 252, 0.35);
    }
    .game-button-1::before { content: '‚ùÑÔ∏è'; }
    .game-button-1.active  { box-shadow: 0 0 55px #7dd3fc, 0 0 20px #7dd3fc; border-color: #7dd3fc; }

    /* Storm */
    .game-button-2 {
      background: linear-gradient(135deg, #3b2503, #a16207, #3b2503);
      box-shadow: 0 4px 24px rgba(161, 98, 7, 0.4);
      border-color: rgba(253, 224, 71, 0.35);
    }
    .game-button-2::before { content: '‚ö°'; }
    .game-button-2.active  { box-shadow: 0 0 55px #fde047, 0 0 20px #fde047; border-color: #fde047; }

    /* Nature */
    .game-button-3 {
      background: linear-gradient(135deg, #0a2010, #166534, #0a2010);
      box-shadow: 0 4px 24px rgba(22, 101, 52, 0.4);
      border-color: rgba(134, 239, 172, 0.35);
    }
    .game-button-3::before { content: 'üçÉ'; }
    .game-button-3.active  { box-shadow: 0 0 55px #86efac, 0 0 20px #86efac; border-color: #86efac; }

    /* Active / Wrong states */
    .game-button:not(:disabled):hover {
      transform: scale(1.05);
      filter: brightness(0.9) saturate(1.1);
    }

    .game-button:disabled { cursor: not-allowed; }

    .game-button.active {
      transform: scale(0.95);
      filter: brightness(1.6) saturate(1.4);
      animation: pulse-glow 0.3s ease-in-out;
    }

    @keyframes pulse-glow {
      0%, 100% { filter: brightness(1.6); }
      50%       { filter: brightness(2); }
    }

    .game-button.wrong {
      filter: brightness(0.35) saturate(0);
    }

    .game-button.wrong::before {
      content: 'üíÄ' !important;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4rem;
      animation: skull-appear 0.3s ease-out;
    }

    @keyframes skull-appear {
      from { transform: translate(-50%, -50%) scale(0) rotate(-30deg); opacity: 0; }
      to   { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
    }

    /* ---- Stats ---- */
    .stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 32px;
      position: relative;
      z-index: 2;
    }

    .stat-label {
      font-family: 'Cinzel', serif;
      font-size: 0.75rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      opacity: 0.6;
      margin-bottom: 2px;
    }

    .stat-value {
      font-family: 'Cinzel Decorative', serif;
      font-size: 1.8rem;
      font-weight: 700;
    }

    .stat-round .stat-value { color: var(--arcane-light); text-shadow: 0 0 14px var(--arcane); }
    .stat-score .stat-value { color: var(--gold); text-shadow: 0 0 14px var(--gold); }
    .stat-score { text-align: right; }

    /* ---- Watch Sequence Message ---- */
    .watch-sequence {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 1.2rem;
      color: var(--gold-light);
      animation: pulse 1.2s ease-in-out infinite;
      margin-top: 20px;
      position: relative;
      z-index: 2;
      letter-spacing: 0.06em;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.4; }
    }

    /* ---- Success Overlay ---- */
    .success-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      pointer-events: none;
    }

    .success-circle {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(201,162,39,0.15) 0%, transparent 70%);
      border: 3px solid var(--gold);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: success-appear 0.3s ease-out, success-fadeout 0.5s ease-in 1.5s forwards;
      box-shadow: 0 0 50px rgba(201, 162, 39, 0.7), 0 0 100px rgba(201, 162, 39, 0.3);
    }

    .success-tick {
      font-size: 6rem;
      animation: tick-draw 0.4s ease-out 0.2s forwards;
      opacity: 0;
    }

    @keyframes success-appear {
      from { transform: scale(0) rotate(-45deg); opacity: 0; }
      to   { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes success-fadeout {
      from { opacity: 1; transform: scale(1); }
      to   { opacity: 0; transform: scale(1.3); }
    }
    @keyframes tick-draw {
      from { opacity: 0; transform: scale(0.4) rotate(20deg); }
      to   { opacity: 1; transform: scale(1) rotate(0deg); }
    }

    /* ---- High Scores Box ---- */
    .highscores-box {
      background: linear-gradient(135deg, rgba(10,7,2,0.85), rgba(20,12,4,0.9));
      backdrop-filter: blur(12px);
      border: 1px solid rgba(201, 162, 39, 0.35);
      border-radius: 10px;
      padding: 24px;
      margin-top: 36px;
      position: relative;
      z-index: 2;
      box-shadow: 0 0 40px rgba(0,0,0,0.5), inset 0 0 30px rgba(201, 162, 39, 0.03);
    }

    .highscores-box::before {
      content: '‚ú¶ ‚ú¶ ‚ú¶';
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      background: #04080a;
      padding: 0 12px;
      color: var(--gold);
      font-size: 0.8rem;
      letter-spacing: 0.4em;
    }

    .highscores-title {
      font-family: 'Cinzel', serif;
      font-size: 1.1rem;
      letter-spacing: 0.25em;
      color: var(--gold);
      margin-bottom: 16px;
      text-transform: uppercase;
    }

    .highscore-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      margin: 6px 0;
      background: rgba(201, 162, 39, 0.06);
      border: 1px solid rgba(201, 162, 39, 0.1);
      border-radius: 6px;
      font-size: 1rem;
    }

    .highscore-rank {
      color: var(--gold);
      font-family: 'Cinzel', serif;
      font-weight: 600;
      width: 40px;
      font-size: 0.85rem;
    }

    .highscore-initials {
      font-family: 'Cinzel', serif;
      font-size: 1rem;
      letter-spacing: 0.15em;
    }

    .highscore-score { color: var(--arcane-light); font-weight: 600; }

    /* ---- Game Over ---- */
    .gameover-screen {
      text-align: center;
      position: relative;
      z-index: 2;
    }

    .gameover-title {
      font-family: 'Cinzel Decorative', serif;
      font-size: 3rem;
      color: #dc2626;
      text-shadow: 0 0 30px #dc2626, 0 0 60px rgba(220, 38, 38, 0.4);
      animation: pulse 1.5s ease-in-out infinite;
      margin-bottom: 24px;
      letter-spacing: 0.05em;
    }

    .gameover-stats {
      font-size: 1.4rem;
      margin: 20px 0;
      font-family: 'IM Fell English', serif;
    }

    .gameover-stats div { margin: 8px 0; }

    .new-highscore {
      font-family: 'Cinzel', serif;
      font-size: 1.2rem;
      color: var(--gold);
      text-shadow: 0 0 20px var(--gold);
      letter-spacing: 0.2em;
      font-weight: 600;
      margin: 20px 0;
      animation: pulse 1s ease-in-out infinite;
    }

    .initials-input {
      background: rgba(10, 7, 2, 0.9);
      color: var(--gold);
      font-family: 'Cinzel', serif;
      font-size: 1.8rem;
      font-weight: bold;
      text-align: center;
      padding: 12px;
      border: 1px solid rgba(201, 162, 39, 0.6);
      border-radius: 6px;
      width: 150px;
      text-transform: uppercase;
      margin: 16px 0;
      letter-spacing: 0.3em;
      outline: none;
    }
    .initials-input:focus {
      border-color: var(--gold);
      box-shadow: 0 0 20px rgba(201, 162, 39, 0.3);
    }

    /* ---- Decorative Divider ---- */
    .divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 20px 0;
      color: rgba(201, 162, 39, 0.4);
      font-size: 0.7rem;
      letter-spacing: 0.3em;
    }
    .divider::before, .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(201, 162, 39, 0.35), transparent);
    }

    .hidden { display: none; }

    @media (max-width: 640px) {
      h1 { font-size: 2.2rem; }
      .tagline { font-size: 0.9rem; }
      .game-buttons-grid { max-width: 290px; gap: 14px; }
      .gameover-title { font-size: 2.2rem; }
    }
  </style>
</head>
<body>
  <!-- Atmosphere layers -->
  <div id="atmosphere">
    <div class="mist-layer mist-1"></div>
    <div class="mist-layer mist-2"></div>
    <div class="mist-layer mist-3"></div>
  </div>
  <canvas id="particles-canvas"></canvas>

  <div id="game-container">
    <div id="game-content">

      <!-- Success Overlay -->
      <div id="success-overlay" class="success-overlay hidden">
        <div class="success-circle">
          <div class="success-tick">‚ú®</div>
        </div>
      </div>

      <!-- Menu Screen -->
      <div id="menu-screen">
        <div class="title-wrapper">
          <div class="rune-ring ring-1"></div>
          <div class="rune-ring ring-2"></div>
          <div class="rune-ring ring-3"></div>
          <div class="rune-ring ring-4"></div>
          <h1>ARCANE MEMORY</h1>
        </div>
        <p class="tagline">Commune with the elements ‚Äî repeat the spell or be consumed</p>
        <button class="button" onclick="startGame()">‚öó Begin the Ritual ‚öó</button>

        <div class="highscores-box">
          <div class="highscores-title">Hall of Archmages</div>
          <div id="highscores-list"></div>
        </div>
      </div>

      <!-- Playing Screen -->
      <div id="playing-screen" class="hidden">
        <div class="stats">
          <div class="stat-round">
            <div class="stat-label">Incantation</div>
            <div class="stat-value"><span id="round-display">1</span></div>
          </div>
          <div class="stat-score">
            <div class="stat-label">Power</div>
            <div class="stat-value"><span id="score-display">0</span></div>
          </div>
        </div>

        <div style="position: relative; margin: 0 auto; max-width: 460px;">
          <div class="rune-ring ring-1"></div>
          <div class="rune-ring ring-2"></div>
          <div class="rune-ring ring-3"></div>
          <div class="rune-ring ring-4"></div>

          <div class="game-buttons-grid">
            <button class="game-button game-button-0"></button>
            <button class="game-button game-button-1"></button>
            <button class="game-button game-button-2"></button>
            <button class="game-button game-button-3"></button>
          </div>
        </div>

        <div id="watch-message" class="watch-sequence hidden">‚ú¶ The spirits weave their spell‚Ä¶ ‚ú¶</div>
      </div>

      <!-- Game Over Screen -->
      <div id="gameover-screen" class="hidden gameover-screen">
        <h2 class="gameover-title">SPELL BROKEN</h2>
        <div class="gameover-stats">
          <div>The ritual lasted <strong><span id="final-round">1</span></strong> incantations</div>
          <div style="color: var(--gold);">Power amassed: <strong><span id="final-score">0</span></strong></div>
        </div>

        <div class="divider">‚ú¶ ‚ú¶ ‚ú¶</div>

        <div id="new-highscore-section" class="hidden">
          <div class="new-highscore">‚≠ê YOUR NAME SHALL BE ETCHED IN THE SPELLBOOK ‚≠ê</div>
          <div>
            <label style="font-size: 1rem; color: #a89060; font-style: italic; letter-spacing: 0.1em;">Inscribe your initials (2‚Äì3 runes):</label><br>
            <input type="text" id="initials-input" class="initials-input" maxlength="3" placeholder="AAA">
          </div>
          <button class="button" onclick="submitScore()" id="submit-button" disabled>Seal the Pact</button>
        </div>

        <button class="button" id="back-to-menu-button" onclick="backToMenu()">Return to Sanctum</button>
      </div>

    </div>
  </div>

  <script>
    // ---- Game State ----
    let gameState = 'menu';
    let sequence = [];
    let playerSequence = [];
    let isPlaying = false;
    let round = 1;
    let score = 0;
    let highScores = [];
    let audioContext;

    // Elemental tones (pentatonic-ish for mystical feel)
    const colors = [
      { sound: 293.66 },  // D4  - Fire
      { sound: 370.00 },  // F#4 - Frost
      { sound: 440.00 },  // A4  - Storm
      { sound: 587.33 }   // D5  - Nature
    ];

    // ---- Init ----
    window.onload = function() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      spawnParticles();
      loadHighScores();
    };

    // ---- Floating Magical Particles ----
    function spawnParticles() {
      const canvas = document.getElementById('particles-canvas');
      const ctx = canvas.getContext('2d');

      function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      resize();
      window.addEventListener('resize', resize);

      const particles = Array.from({ length: 55 }, () => createParticle());

      function createParticle(fromBottom = false) {
        const hues = [40, 280, 130, 50]; // gold, purple, green, amber
        const hue = hues[Math.floor(Math.random() * hues.length)];
        return {
          x: Math.random() * canvas.width,
          y: fromBottom ? canvas.height + 10 : Math.random() * canvas.height,
          vx: (Math.random() - 0.5) * 0.3,
          vy: -(Math.random() * 0.4 + 0.1),
          radius: Math.random() * 2.5 + 0.5,
          alpha: Math.random() * 0.6 + 0.1,
          hue,
          life: Math.random(),
          lifeDelta: Math.random() * 0.005 + 0.001,
          twinkleSpeed: Math.random() * 0.03 + 0.01
        };
      }

      let t = 0;
      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        t++;

        particles.forEach((p, i) => {
          p.x += p.vx;
          p.y += p.vy;
          p.life += p.lifeDelta;

          const twinkle = (Math.sin(t * p.twinkleSpeed) + 1) / 2;
          const alpha = p.alpha * (0.4 + 0.6 * twinkle);

          ctx.save();
          ctx.globalAlpha = alpha;

          const grd = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.radius * 3);
          grd.addColorStop(0, `hsla(${p.hue}, 90%, 75%, 1)`);
          grd.addColorStop(1, `hsla(${p.hue}, 90%, 75%, 0)`);
          ctx.fillStyle = grd;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.radius * 3, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();

          if (p.y < -20 || p.x < -20 || p.x > canvas.width + 20) {
            particles[i] = createParticle(true);
          }
        });

        requestAnimationFrame(draw);
      }

      draw();
    }

    // ---- High Scores ----
    const WORKER_URL = 'https://cshs.aransmithson.workers.dev';

    async function loadHighScores() {
      try {
        const response = await fetch(`${WORKER_URL}/highscores`);
        if (response.ok) {
          highScores = await response.json();
          highScores.sort((a, b) => b.score - a.score);
          highScores = highScores.slice(0, 10);
        }
      } catch (error) {
        highScores = [];
      }
      displayHighScores();
    }

    function displayHighScores() {
      const list = document.getElementById('highscores-list');
      if (highScores.length === 0) {
        list.innerHTML = '<p style="color: #6b5a30; font-size: 1rem; font-style: italic;">The pages are blank ‚Äî be the first archmage.</p>';
      } else {
        const medals = ['‚ú¶', '‚úß', '‚óà'];
        list.innerHTML = highScores.slice(0, 5).map((score, i) => `
          <div class="highscore-entry">
            <span class="highscore-rank">${medals[i] || '#' + (i+1)}</span>
            <span class="highscore-initials">${score.initials}</span>
            <span class="highscore-score">${score.score}</span>
          </div>
        `).join('');
      }
    }

    async function saveHighScore(initials, finalScore) {
      try {
        const response = await fetch(`${WORKER_URL}/highscores`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ initials: initials.toUpperCase(), score: finalScore })
        });
        if (response.ok) {
          highScores = await response.json();
          displayHighScores();
        }
      } catch (error) {
        console.error('Failed to save score:', error);
      }
    }

    // ---- Audio ----
    // Each elemental button has a base note; we play a soft triad chord (root + 5th + octave)
    // with a gentle attack and long mystical tail ‚Äî no beep, just chimes.
    function playChime(rootFreq) {
      if (!audioContext) return;
      const now = audioContext.currentTime;

      // Harmonics: root, perfect 5th (√ó1.5), octave (√ó2), soft upper octave (√ó3)
      const partials = [
        { freq: rootFreq,        gain: 0.22, dur: 1.2 },
        { freq: rootFreq * 1.5,  gain: 0.12, dur: 0.9 },
        { freq: rootFreq * 2.0,  gain: 0.08, dur: 0.7 },
        { freq: rootFreq * 3.0,  gain: 0.04, dur: 0.5 },
      ];

      partials.forEach(({ freq, gain, dur }) => {
        const osc  = audioContext.createOscillator();
        const g    = audioContext.createGain();
        osc.connect(g);
        g.connect(audioContext.destination);
        osc.type = 'sine';
        osc.frequency.value = freq;
        // Soft attack, long natural decay
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(gain, now + 0.015);
        g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
        osc.start(now);
        osc.stop(now + dur);
      });
    }

    function playErrorSound() {
      if (!audioContext) return;
      const now = audioContext.currentTime;
      // Low dissonant growl ‚Äî two slightly detuned oscillators
      [110, 116].forEach(freq => {
        const osc = audioContext.createOscillator();
        const g   = audioContext.createGain();
        osc.connect(g);
        g.connect(audioContext.destination);
        osc.type = 'sawtooth';
        osc.frequency.value = freq;
        g.gain.setValueAtTime(0.15, now);
        g.gain.exponentialRampToValueAtTime(0.0001, now + 0.9);
        osc.start(now);
        osc.stop(now + 0.9);
      });
    }

    function playSuccessSound() {
      if (!audioContext) return;
      const now = audioContext.currentTime;
      // Rising arpeggio: D5 ‚Üí F#5 ‚Üí A5 ‚Üí D6
      [587.33, 739.99, 880, 1174.66].forEach((freq, i) => {
        const osc = audioContext.createOscillator();
        const g   = audioContext.createGain();
        osc.connect(g);
        g.connect(audioContext.destination);
        osc.type = 'sine';
        osc.frequency.value = freq;
        const t = now + i * 0.09;
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.15, t + 0.015);
        g.gain.exponentialRampToValueAtTime(0.0001, t + 0.7);
        osc.start(t);
        osc.stop(t + 0.7);
      });
    }

    // ---- Game Logic ----
    function startGame() {
      gameState = 'playing';
      sequence = [];
      playerSequence = [];
      round = 1;
      score = 0;
      document.getElementById('success-overlay').classList.add('hidden');
      showScreen('playing-screen');
      updateDisplay();
      nextRound();
    }

    function nextRound() {
      if (sequence.length === 0) {
        const len = 4 + (round - 1);
        sequence = Array.from({ length: len }, () => Math.floor(Math.random() * 4));
      } else {
        sequence.push(Math.floor(Math.random() * 4));
      }
      playerSequence = [];
      playSequence();
    }

    async function playSequence() {
      isPlaying = true;
      disableButtons(true);
      document.getElementById('watch-message').classList.remove('hidden');

      const baseDelay = 450;
      const minDelay = 160;
      const speedReduction = Math.floor((round - 1) / 3) * 50;
      const delay = Math.max(minDelay, baseDelay - speedReduction);

      for (let i = 0; i < sequence.length; i++) {
        await sleep(delay);
        activateButton(sequence[i]);
        playChime(colors[sequence[i]].sound);
        await sleep(delay);
        deactivateButton(sequence[i]);
      }

      document.getElementById('watch-message').classList.add('hidden');
      isPlaying = false;
      disableButtons(false);
    }

    function handleButtonClick(buttonId) {
      if (isPlaying) return;

      playerSequence.push(buttonId);

      if (buttonId !== sequence[playerSequence.length - 1]) {
        playErrorSound();
        disableButtons(true);
        const wrongButton = document.querySelector(`.game-button-${buttonId}`);
        wrongButton.classList.add('wrong');
        setTimeout(() => {
          wrongButton.classList.remove('wrong');
          gameOver();
        }, 3000);
        return;
      }

      activateButton(buttonId);
      playChime(colors[buttonId].sound);
      setTimeout(() => deactivateButton(buttonId), 300);

      if (playerSequence.length === sequence.length) {
        score += sequence.length * 10;
        round++;
        updateDisplay();
        disableButtons(true);
        playSuccessSound();
        const successOverlay = document.getElementById('success-overlay');
        successOverlay.classList.remove('hidden');
        setTimeout(() => {
          successOverlay.classList.add('hidden');
          nextRound();
        }, 2000);
      }
    }

    function gameOver() {
      gameState = 'gameover';
      document.getElementById('final-round').textContent = round;
      document.getElementById('final-score').textContent = score;

      const isHighScore = highScores.length < 10 || score > highScores[highScores.length - 1]?.score;
      if (isHighScore) {
        document.getElementById('new-highscore-section').classList.remove('hidden');
        document.getElementById('back-to-menu-button').classList.add('hidden');
        document.getElementById('initials-input').focus();
      } else {
        document.getElementById('new-highscore-section').classList.add('hidden');
        document.getElementById('back-to-menu-button').classList.remove('hidden');
      }
      showScreen('gameover-screen');
    }

    function submitScore() {
      const initials = document.getElementById('initials-input').value.trim().toUpperCase();
      if (initials.length >= 2) {
        saveHighScore(initials, score);
        document.getElementById('initials-input').value = '';
        backToMenu();
      }
    }

    function backToMenu() {
      gameState = 'menu';
      showScreen('menu-screen');
    }

    // ---- UI Helpers ----
    function showScreen(screenId) {
      ['menu-screen', 'playing-screen', 'gameover-screen'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
      document.getElementById(screenId).classList.remove('hidden');
    }

    function updateDisplay() {
      document.getElementById('round-display').textContent = round;
      document.getElementById('score-display').textContent = score;
    }

    function activateButton(id) {
      document.querySelector(`.game-button-${id}`).classList.add('active');
    }
    function deactivateButton(id) {
      document.querySelector(`.game-button-${id}`).classList.remove('active');
    }
    function disableButtons(disabled) {
      document.querySelectorAll('.game-button').forEach(btn => btn.disabled = disabled);
    }
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ---- Input handlers ----
    document.addEventListener('DOMContentLoaded', () => {
      // Touch-safe button handlers ‚Äî prevent touch‚Üíclick double-fire
      document.querySelectorAll('.game-button').forEach((btn, i) => {
        btn.addEventListener('touchstart', (e) => {
          e.preventDefault(); // stop the ghost click that follows
          handleButtonClick(i);
        }, { passive: false });
        btn.addEventListener('click', () => {
          // Only fires on true mouse clicks (touch is blocked above)
          handleButtonClick(i);
        });
      });
      const input = document.getElementById('initials-input');
      if (input) {
        input.addEventListener('keypress', e => { if (e.key === 'Enter') submitScore(); });
        input.addEventListener('input', e => {
          document.getElementById('submit-button').disabled = e.target.value.length < 2;
        });
      }
    });
  </script>
</body>
</html>
